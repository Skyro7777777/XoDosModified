name: xAdd Submodules

on:
  workflow_dispatch:

permissions:
  contents: write   # allow workflow to push changes

jobs:
  add-submodules:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Add submodules if not present
        run: |
          git submodule add https://github.com/KhronosGroup/OpenXR-SDK.git xodos-x11/src/main/cpp/OpenXR-SDK || true
          git submodule add https://gitlab.com/bzip2/bzip2 xodos-x11/src/main/cpp/bzip2 || true
          git submodule add https://github.com/anholt/libepoxy xodos-x11/src/main/cpp/libepoxy || true
          git submodule add https://gitlab.freedesktop.org/xorg/lib/libfontenc xodos-x11/src/main/cpp/libfontenc || true
          git submodule add https://github.com/alisw/libtirpc xodos-x11/src/main/cpp/libtirpc || true
          git submodule add https://gitlab.freedesktop.org/xorg/lib/libx11 xodos-x11/src/main/cpp/libx11 || true
          git submodule add https://gitlab.freedesktop.org/xorg/lib/libxau xodos-x11/src/main/cpp/libxau || true
          git submodule add https://gitlab.freedesktop.org/xorg/lib/libxcvt xodos-x11/src/main/cpp/libxcvt || true
          git submodule add https://gitlab.freedesktop.org/xorg/lib/libxdmcp xodos-x11/src/main/cpp/libxdmcp || true
          git submodule add https://gitlab.freedesktop.org/xorg/lib/libxfont xodos-x11/src/main/cpp/libxfont || true
          git submodule add https://gitlab.freedesktop.org/xorg/lib/libxkbfile xodos-x11/src/main/cpp/libxkbfile || true
          git submodule add https://gitlab.freedesktop.org/xorg/lib/libxshmfence xodos-x11/src/main/cpp/libxshmfence || true
          git submodule add https://gitlab.freedesktop.org/xorg/lib/libxtrans xodos-x11/src/main/cpp/libxtrans || true
          git submodule add https://gitlab.freedesktop.org/pixman/pixman xodos-x11/src/main/cpp/pixman || true
          git submodule add https://gitlab.freedesktop.org/xorg/app/xkbcomp xodos-x11/src/main/cpp/xkbcomp || true
          git submodule add https://gitlab.freedesktop.org/xorg/proto/xorgproto xodos-x11/src/main/cpp/xorgproto || true
          git submodule add https://gitlab.freedesktop.org/xorg/xserver xodos-x11/src/main/cpp/xserver || true

          git submodule sync --recursive
          git submodule update --init --recursive

      - name: Commit and push submodules to main
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add .gitmodules xodos-x11/src/main/cpp/* || true
          git commit -m "5.9.0 - add/update submodules" || echo "No changes to commit"
          git push origin HEAD:main
